<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Lokstra Framework</title>
    
    <!-- Prevent FOUC - Apply theme immediately -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('lokstra-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <!-- tailwind.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css">
   
    <!-- Lokstra Theme CSS -->
    <link rel="stylesheet" href="/components/theme.css">
    
    <!-- Dashboard-specific CSS -->
    <link rel="stylesheet" href="/static/css/dashboard.css">

    <script src="/static/js/init-loader.js"></script>

    <!-- HTMX -->
    <!-- <script src="https://unpkg.com/htmx.org@2.0.6"></script> -->
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Lucide Icons - using specific stable version -->
    <!-- <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.js"></script> -->
    
    <!-- Lokstra Theme Manager - Single Source of Truth -->
    <!-- <script src="/static/js/theme-manager.js"></script> -->

    <!-- Lokstra Web Components -->
    <!-- <script type="module" src="/components/register-all.js"></script> -->

    <style>
        /* CSS Variables for Themes */
        :root {
            /* Light theme - Soft blue-gray palette with depth */
            --ls-bg-primary: #c0d0df;
            --ls-bg-secondary: #d4e2f0;
            --ls-bg-tertiary: #e8f0f8;
            --ls-text-primary: #2c3e50;
            --ls-text-secondary: #34495e;
            --ls-text-muted: #5a6b7c;
            --ls-border-primary: #bdc3c7;
            --ls-border-secondary: #95a5a6;
            --ls-shadow-sm: 0 1px 3px 0 rgba(44, 62, 80, 0.1);
            --ls-shadow-md: 0 2px 6px -1px rgba(44, 62, 80, 0.15);
            --ls-shadow-lg: 0 4px 12px -2px rgba(44, 62, 80, 0.2);
            --ls-border-radius-lg: 0.5rem;
            --ls-success-600: #27ae60;
            --ls-error-600: #e74c3c;
            --ls-warning-600: #f39c12;
            
            /* Panel colors - slightly different from background */
            --ls-panel-bg: #ced8dd;
            --ls-card-bg: #adc1dd;
        }
        
        [data-theme="dark"] {
            /* Dark theme */
            --ls-bg-primary: #111827;
            --ls-bg-secondary: #1f2937;
            --ls-bg-tertiary: #374151;
            --ls-text-primary: #f9fafb;
            --ls-text-secondary: #e5e7eb;
            --ls-text-muted: #d1d5db;
            --ls-border-primary: #374151;
            --ls-border-secondary: #4b5563;
            --ls-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --ls-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --ls-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --ls-success-600: #10b981;
            --ls-error-600: #f87171;
            --ls-warning-600: #fbbf24;
            
            /* Panel colors for dark theme */
            --ls-panel-bg: #1f2937;
            --ls-card-bg: #374151;
            
            /* Sidebar dark theme */
            --ls-sidebar-bg: #111827;
            --ls-sidebar-border: #374151;
            --ls-sidebar-text: #f9fafb;
            --ls-sidebar-text-muted: #9ca3af;
            --ls-sidebar-item-hover-bg: #1f2937;
            --ls-sidebar-item-active-bg: #3b82f6;
            --ls-sidebar-item-active-border: #60a5fa;
        }
        
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Smooth theme transitions for all elements */
        *, *::before, *::after {
            transition: 
                background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Enhanced transitions during theme switching */
        .theme-transitioning * {
            transition: 
                background-color 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                border-color 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                color 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* Preserve specific transitions for interactive elements */
        .stat-card, .content-card, .ls-btn {
            transition: 
                background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Enhanced transitions during theme switching for interactive elements */
        .theme-transitioning .stat-card,
        .theme-transitioning .content-card,
        .theme-transitioning .ls-btn {
            transition: 
                background-color 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                border-color 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                color 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--ls-bg-primary);
            color: var(--ls-text-primary);
        }
        
        .content-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background-color: var(--ls-bg-primary);
            color: var(--ls-text-primary);
        }
        
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
            flex: 1;
        }
        
        /* Sidebar Container - Wrapper untuk ls-sidebar component */
        .sidebar-container {
            width: var(--ls-sidebar-width, 16rem);
            transition: width 0.3s ease-in-out;
            background-color: var(--ls-sidebar-bg, var(--ls-bg-secondary));
            border-right: 1px solid var(--ls-sidebar-border, var(--ls-border-primary));
            position: relative;
            z-index: 40;
        }
        
        .sidebar-container.collapsed {
            width: var(--ls-sidebar-collapsed-width, 4rem);
        }
        
        /* Ensure ls-sidebar fills the container */
        ls-sidebar {
            display: block;
            width: 100%;
            height: 100vh;
        }
        
        /* Fallback styling if web component fails to load */
        .sidebar-container:not(:has(ls-sidebar)) {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ls-text-muted);
            font-size: 0.875rem;
        }
        
        .sidebar-container:not(:has(ls-sidebar))::before {
            content: "Loading sidebar...";
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--ls-text-primary);
            margin-bottom: 0.5rem;
        }
        
        .page-subtitle {
            color: var(--ls-text-muted);
            font-size: 1rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-actions {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--ls-panel-bg);
            border-radius: var(--ls-border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--ls-shadow-md);
            border: 1px solid var(--ls-border-primary);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            box-shadow: var(--ls-shadow-lg);
            transform: translateY(-2px);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--ls-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-icon {
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: var(--ls-bg-tertiary);
            color: #60a5fa;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--ls-text-primary);
            margin-bottom: 0.25rem;
        }
        
        .stat-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .stat-change.positive {
            color: var(--ls-success-600);
        }
        
        .stat-change.negative {
            color: var(--ls-error-600);
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .content-card {
            background: var(--ls-card-bg);
            border-radius: var(--ls-border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--ls-shadow-md);
            border: 1px solid var(--ls-border-primary);
            transition: all 0.3s ease;
        }
        
        .content-card:hover {
            box-shadow: var(--ls-shadow-lg);
            transform: translateY(-1px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--ls-border-primary);
            background: transparent;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--ls-text-primary);
            background: transparent;
        }
        
        .footer {
            background: var(--ls-bg-secondary);
            border-top: 1px solid var(--ls-border-primary);
            color: var(--ls-text-muted);
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none;
        }
        
        .mobile-overlay.show {
            display: block;
        }
        
        /* Button styles */
        .ls-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.25;
            border-radius: 0.375rem;
            border: 1px solid transparent;
            text-decoration: none;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease-in-out;
        }

        .ls-btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .ls-btn-outline {
            color: var(--ls-text-secondary);
            background-color: transparent;
            border-color: var(--ls-border-secondary);
        }

        .ls-btn-outline:hover {
            background-color: var(--ls-bg-secondary);
            border-color: var(--ls-text-muted);
            color: var(--ls-text-primary);
            transform: translateY(-1px);
        }
        
        /* Button icon styling */
        .ls-btn i[data-lucide],
        .ls-btn svg[data-lucide] {
            width: 1rem;
            height: 1rem;
            stroke: currentColor;
            flex-shrink: 0;
        }
        
        /* Lucide Icons Styling - Fixed stroke colors with higher specificity */
        body svg[data-lucide] {
            display: inline-block !important;
            width: inherit !important;
            height: inherit !important;
            stroke-width: 2 !important;
            fill: none !important;
            stroke: var(--ls-text-primary) !important;
            color: var(--ls-text-primary) !important;
        }
        
        /* Specific icon color overrides for better visibility */
        body .stat-icon svg[data-lucide] {
            stroke: #60a5fa !important;
            color: #60a5fa !important;
        }
        
        body .stat-change.positive svg[data-lucide] {
            stroke: var(--ls-success-600) !important;
            color: var(--ls-success-600) !important;
        }
        
        body .stat-change.negative svg[data-lucide] {
            stroke: var(--ls-error-600) !important;
            color: var(--ls-error-600) !important;
        }
        
        /* Theme switcher icon */
        body #themeIcon {
            stroke: currentColor !important;
            color: currentColor !important;
        }
        
        /* Icons in content areas */
        body #activityContent svg[data-lucide] {
            stroke: var(--ls-text-muted) !important;
            color: var(--ls-text-muted) !important;
        }
        
        /* Success/status icons */
        body span[style*="success"] svg[data-lucide] {
            stroke: var(--ls-success-600) !important;
            color: var(--ls-success-600) !important;
        }
        
        body i[data-lucide] {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        #activityContent * {
            background-color: inherit;
            color: inherit;
        }
        
        #activityContent div[style*="background-color"] {
            background-color: var(--ls-bg-secondary) !important;
            border-color: var(--ls-border-primary) !important;
        }
        
        #activityContent h4 {
            color: var(--ls-text-primary) !important;
        }
        
        #activityContent p {
            color: var(--ls-text-secondary) !important;
        }
        
        #activityContent time {
            color: var(--ls-text-muted) !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .page-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .sidebar-container {
                position: fixed;
                top: 0;
                left: 0;
                z-index: 40;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            
            .sidebar-container.open {
                transform: translateX(0);
            }
        }
        
        @media (min-width: 769px) {
            .mobile-overlay {
                display: none !important;
            }
        }
    </style>
</head>

<body x-data="dashboard">
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <div class="sidebar-container" id="sidebarContainer">
            <ls-sidebar id="sidebar"></ls-sidebar>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navigation -->
            <ls-navbar id="navbar"></ls-navbar>

            <!-- Page Content -->
            <div class="content-area" id="pageContent">
                <!-- Page Header -->
                <div class="page-header">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h1 class="page-title">{{.Title}}</h1>
                            <p class="page-subtitle">{{.Subtitle}}</p>
                        </div>
                        
                        <!-- Theme Switcher Component -->
                        <lokstra-theme-switcher></lokstra-theme-switcher>
                    </div>
                    
                    <div class="page-actions">
                        <ls-button text="New Project" variant="primary" icon="plus" hx-get="/projects/new" hx-target="#pageContent"></ls-button>
                        <ls-button text="Export Data" variant="outline" icon="download" hx-get="/api/export" hx-target="#dynamicContent"></ls-button>
                        <ls-button text="Settings" variant="outline" icon="settings" hx-get="/settings" hx-target="#pageContent"></ls-button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    {{range .Stats}}
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">{{.Title}}</span>
                            <div class="stat-icon">
                                <i data-lucide="{{.Icon}}" style="width: 1.25rem; height: 1.25rem;"></i>
                            </div>
                        </div>
                        <div class="stat-value">{{.Value}}</div>
                        <div class="stat-change {{.Type}}">
                            {{if eq .Type "positive"}}
                                <i data-lucide="trending-up" style="width: 1rem; height: 1rem;"></i>
                            {{else if eq .Type "negative"}}
                                <i data-lucide="trending-down" style="width: 1rem; height: 1rem;"></i>
                            {{else}}
                                <i data-lucide="activity" style="width: 1rem; height: 1rem;"></i>
                            {{end}}
                            {{.Change}}
                        </div>
                    </div>
                    {{end}}
                    {{if not .Stats}}
                    <!-- Default stats if no data provided -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Total Users</span>
                            <div class="stat-icon">
                                <i data-lucide="users" style="width: 1.25rem; height: 1.25rem;"></i>
                            </div>
                        </div>
                        <div class="stat-value">2,845</div>
                        <div class="stat-change positive">
                            <i data-lucide="trending-up" style="width: 1rem; height: 1rem;"></i>
                            +12% from last month
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Revenue</span>
                            <div class="stat-icon">
                                <i data-lucide="dollar-sign" style="width: 1.25rem; height: 1.25rem;"></i>
                            </div>
                        </div>
                        <div class="stat-value">$48,290</div>
                        <div class="stat-change positive">
                            <i data-lucide="trending-up" style="width: 1rem; height: 1rem;"></i>
                            +8% from last month
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Orders</span>
                            <div class="stat-icon">
                                <i data-lucide="shopping-cart" style="width: 1.25rem; height: 1.25rem;"></i>
                            </div>
                        </div>
                        <div class="stat-value">1,248</div>
                        <div class="stat-change negative">
                            <i data-lucide="trending-down" style="width: 1rem; height: 1rem;"></i>
                            -3% from last month
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Conversion</span>
                            <div class="stat-icon">
                                <i data-lucide="target" style="width: 1.25rem; height: 1.25rem;"></i>
                            </div>
                        </div>
                        <div class="stat-value">3.24%</div>
                        <div class="stat-change positive">
                            <i data-lucide="trending-up" style="width: 1rem; height: 1rem;"></i>
                            +0.5% from last month
                        </div>
                    </div>
                    {{end}}
                </div>
                
                <!-- Content Grid -->
                <div class="content-grid">
                    <!-- Main Content Card -->
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Recent Activity</h2>
                            <ls-button text="View All" variant="outline" size="sm" hx-get="/activity" hx-target="#pageContent"></ls-button>
                        </div>
                        
                        <div id="activityContent" style="background-color: var(--ls-card-bg); color: var(--ls-text-primary); border-radius: var(--ls-border-radius-lg);">
                            <p style="color: var(--ls-text-muted); text-align: center; padding: 2rem;">
                                <i data-lucide="activity" style="width: 2rem; height: 2rem; margin-bottom: 0.5rem; display: block; margin: 0 auto 0.5rem;"></i>
                                Loading recent activity...
                            </p>
                        </div>
                    </div>
                    
                    <!-- Sidebar Content Card -->
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">Quick Actions</h2>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <!-- Quick Actions with ls-button components -->
                            <ls-button
                                fullwidth
                                text="Create User" 
                                variant="outline" 
                                size="sm" 
                                icon="user-plus" 
                                hx-get="/users/new" 
                                hx-target="#pageContent">
                            </ls-button>
                            <ls-button
                                fullwidth
                                text="Generate Report" 
                                variant="outline" 
                                size="sm" 
                                icon="file-text" 
                                hx-get="/reports/new" 
                                hx-target="#pageContent">
                            </ls-button>
                            <ls-button
                                fullwidth
                                text="Backup Data" 
                                variant="outline" 
                                size="sm" 
                                icon="hard-drive">
                            </ls-button>
                            <ls-button
                                fullwidth
                                text="System Health" 
                                variant="outline" 
                                size="sm" 
                                icon="activity" 
                                hx-get="/system/health" 
                                hx-target="#pageContent">
                            </ls-button>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--ls-border-primary);">
                            <h3 style="font-size: 0.875rem; font-weight: 600; color: var(--ls-text-muted); margin-bottom: 1rem;">System Status</h3>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.875rem; color: var(--ls-text-muted);">Server</span>
                                <span style="font-size: 0.875rem; color: var(--ls-success-600); display: flex; align-items: center; gap: 0.25rem;">
                                    <i data-lucide="check-circle" style="width: 0.875rem; height: 0.875rem;"></i>
                                    Online
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.875rem; color: var(--ls-text-muted);">Database</span>
                                <span style="font-size: 0.875rem; color: var(--ls-success-600); display: flex; align-items: center; gap: 0.25rem;">
                                    <i data-lucide="check-circle" style="width: 0.875rem; height: 0.875rem;"></i>
                                    Connected
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.875rem; color: var(--ls-text-muted);">Storage</span>
                                <span style="font-size: 0.875rem; color: var(--ls-warning-600);">78% used</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Content Area for HTMX partial loading -->
                <div id="dynamicContent">
                    <!-- Dynamic content loaded via HTMX will appear here -->
                </div>
            </div>
            
            <!-- Footer -->
            <div class="footer">
                © 2025 Lokstra Framework. Built with ❤️ using Lit Web Components, HTMX & Alpine.js.
            </div>
        </div>
    </div>

    <script>
        // Global timeout and throttling management
        let lucideInitTimeout;
        let isInitializingIcons = false;
        let themeChangeTimeout;
        
        function initLucideIcons() {
            // Prevent multiple simultaneous calls
            if (isInitializingIcons) return;
            
            clearTimeout(lucideInitTimeout);
            lucideInitTimeout = setTimeout(() => {
                if (typeof lucide !== 'undefined' && !isInitializingIcons) {
                    isInitializingIcons = true;
                    
                    try {
                        // Only initialize icons for regular DOM elements (not Shadow DOM)
                        lucide.createIcons({
                            nameAttr: 'data-lucide',
                            attrs: {
                                'stroke-width': 2
                            }
                        });
                    } catch (error) {
                        console.warn("Lucide initialization error:", error);
                    } finally {
                        isInitializingIcons = false;
                    }
                }
            }, 100);
        }
        
        // Throttled theme change handler
        function handleThemeChange() {
            clearTimeout(themeChangeTimeout);
            themeChangeTimeout = setTimeout(() => {
                // Only reinitialize if there are new icons that need processing
                const uninitializedIcons = document.querySelectorAll('i[data-lucide]:not([data-icon-processed])');
                if (uninitializedIcons.length > 0) {
                    initLucideIcons();
                }
            }, 200);
        }
        
        // Wait for DOM and all scripts to load before initializing icons
        window.addEventListener('load', () => {
            setTimeout(() => {
                initLucideIcons();
            }, 500);
        });
        
        // Throttled HTMX content swap handler
        document.addEventListener('htmx:afterSwap', () => {
            // Only reinitialize if new content has lucide icons
            setTimeout(() => {
                const newIcons = document.querySelectorAll('[data-lucide]:not([data-icon-processed])');
                if (newIcons.length > 0) {
                    initLucideIcons();
                }
            }, 100);
        });
        
        // Remove the automatic theme change icon reinitialization to prevent memory leaks
        // Theme switcher component will handle its own icons
        
        // Alpine.js data for dashboard
        document.addEventListener('alpine:init', () => {
            Alpine.data('dashboard', () => ({
                sidebarCollapsed: false,
                sidebarOpen: false,
                
                init() {
                    // Initialize components
                    this.initializeComponents();
                    
                    // Load initial content
                    this.loadInitialContent();
                },
                
                toggleSidebar() {
                    if (window.innerWidth <= 768) {
                        // Mobile: slide sidebar
                        this.sidebarOpen = !this.sidebarOpen;
                        const container = document.getElementById('sidebarContainer');
                        const overlay = document.getElementById('mobileOverlay');
                        container.classList.toggle('open', this.sidebarOpen);
                        overlay.classList.toggle('show', this.sidebarOpen);
                    } else {
                        // Desktop: collapse sidebar
                        this.sidebarCollapsed = !this.sidebarCollapsed;
                        const container = document.getElementById('sidebarContainer');
                        const sidebar = document.getElementById('sidebar');
                        container.classList.toggle('collapsed', this.sidebarCollapsed);
                        sidebar.collapsed = this.sidebarCollapsed;
                    }
                },
                
                initializeComponents() {
                    const sidebar = document.getElementById('sidebar');
                    const navbar = document.getElementById('navbar');
                    
                    if (sidebar && navbar) {
                        // Set sidebar menu items
                        const menuItems = this.getMenuItems();
                        console.log('Setting menu items:', menuItems); // Debug log
                        sidebar.menuItems = menuItems;
                        sidebar.activeItem = 'dashboard';
                        
                        // Set navbar data
                        navbar.user = this.getUserData();
                        navbar.breadcrumb = this.getBreadcrumbData();
                        navbar.notificationCount = 3;
                        
                        // Icons will be initialized by window.load event
                    }
                },
                
                loadInitialContent() {
                    // Load activity content via HTMX
                    setTimeout(() => {
                        if (typeof htmx !== 'undefined') {
                            htmx.ajax('GET', '/api/activity', {
                                target: '#activityContent'
                            });
                        }
                    }, 1000);
                },
                
                getMenuItems() {
                    return [
                        {
                            title: 'Main',
                            items: [
                                { key: 'dashboard', title: 'Dashboard', icon: 'home', url: '/', active: true },
                                { key: 'analytics', title: 'Analytics', icon: 'bar-chart-3', url: '/analytics', hxGet: '/analytics', hxTarget: '#pageContent' }
                            ]
                        },
                        {
                            title: 'Management',
                            items: [
                                {
                                    key: 'users',
                                    title: 'Users',
                                    icon: 'users',
                                    submenu: [
                                        { key: 'users-list', title: 'All Users', url: '/users', hxGet: '/users', hxTarget: '#pageContent' },
                                        { key: 'users-new', title: 'Add User', url: '/users/new', hxGet: '/users/new', hxTarget: '#pageContent' },
                                        { key: 'users-roles', title: 'Roles', url: '/users/roles', hxGet: '/users/roles', hxTarget: '#pageContent' }
                                    ]
                                },
                                { key: 'projects', title: 'Projects', icon: 'folder', url: '/projects', badge: '12', hxGet: '/projects', hxTarget: '#pageContent' },
                                { key: 'reports', title: 'Reports', icon: 'file-text', url: '/reports', hxGet: '/reports', hxTarget: '#pageContent' }
                            ]
                        },
                        {
                            title: 'System',
                            items: [
                                { key: 'settings', title: 'Settings', icon: 'settings', url: '/settings', hxGet: '/settings', hxTarget: '#pageContent' },
                                { key: 'logs', title: 'Logs', icon: 'file-text', url: '/logs', hxGet: '/logs', hxTarget: '#pageContent' }
                            ]
                        }
                    ];
                },
                
                getUserData() {
                    return {
                        name: 'John Doe',
                        role: 'Administrator',
                        avatar: null
                    };
                },
                
                getBreadcrumbData() {
                    return [
                        { title: 'Home', url: '/' },
                        { title: 'Dashboard', url: '/dashboard', active: true }
                    ];
                }
            }));
        });
        
        // Event listeners
        document.addEventListener('toggle-sidebar', () => {
            Alpine.store('dashboard').toggleSidebar();
        });
        
        document.addEventListener('sidebar-toggle', (e) => {
            // Sidebar toggle event handled
        });
        
        document.addEventListener('nav-item-click', (e) => {
            // Navigation item click event handled
            
            // Close mobile sidebar after navigation
            if (window.innerWidth <= 768) {
                document.getElementById('sidebarContainer').classList.remove('open');
                document.getElementById('mobileOverlay').classList.remove('show');
            }
        });
        
        // Close mobile sidebar when clicking overlay
        document.getElementById('mobileOverlay')?.addEventListener('click', () => {
            document.getElementById('sidebarContainer').classList.remove('open');
            document.getElementById('mobileOverlay').classList.remove('show');
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                document.getElementById('sidebarContainer').classList.remove('open');
                document.getElementById('mobileOverlay').classList.remove('show');
            }
        });
        
        // Initialize icons after HTMX content loads
        document.addEventListener('htmx:afterSwap', () => {
            initLucideIcons();
        });
        
        // Initialize components
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize components immediately with hardcoded data
            initializeComponentsWithHardcodedData();
            
            // Try to update with Alpine data after a short delay
            setTimeout(() => {
                updateWithAlpineData();
            }, 500);
        });

        function initializeComponentsWithHardcodedData() {
            // Initialize navbar data
            const navbar = document.getElementById('navbar');
            if (navbar) {
                navbar.breadcrumb = [
                    { title: 'Home', url: '/' },
                    { title: 'Dashboard', url: '/dashboard', active: true }
                ];
                navbar.user = {
                    name: 'John Doe',
                    role: 'Administrator',
                    avatar: null
                };
            }
            
            // Initialize sidebar data with submenu
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                const testMenuItems = [
                    {
                        title: 'Main',
                        items: [
                            { key: 'dashboard', title: 'Dashboard', icon: 'home', url: '/dashboard', active: true },
                            { key: 'analytics', title: 'Analytics', icon: 'bar-chart-2', url: '/analytics' }
                        ]
                    },
                    {
                        title: 'Management',
                        items: [
                            {
                                key: 'users',
                                title: 'Users',
                                icon: 'users',
                                submenu: [
                                    { key: 'users-list', title: 'All Users', url: '/users' },
                                    { key: 'users-new', title: 'Add User', url: '/users/new' },
                                    { key: 'users-roles', title: 'Roles', url: '/users/roles' }
                                ]
                            },
                            { key: 'projects', title: 'Projects', icon: 'folder', url: '/projects', badge: '12' },
                            { key: 'reports', title: 'Reports', icon: 'file-text', url: '/reports' }
                        ]
                    },
                    {
                        title: 'System',
                        items: [
                            { key: 'settings', title: 'Settings', icon: 'settings', url: '/settings' },
                            { key: 'logs', title: 'Logs', icon: 'file-text', url: '/logs' }
                        ]
                    }
                ];
                console.log('Hardcoded menu items with submenu:', testMenuItems); // Debug log
                sidebar.menuItems = testMenuItems;
                sidebar.activeItem = 'dashboard';
            }
            
            // Icons will be initialized by window.load event
        }

        // Wait for Alpine.js to be ready (if it loads)
        document.addEventListener('alpine:init', () => {
            updateWithAlpineData();
        });

        function updateWithAlpineData() {
            try {
                if (Alpine && Alpine.store && Alpine.store('dashboard')) {
                    const navbar = document.getElementById('navbar');
                    const sidebar = document.getElementById('sidebar');
                    
                    if (navbar) {
                        navbar.breadcrumb = Alpine.store('dashboard').getBreadcrumbData();
                        navbar.user = Alpine.store('dashboard').getUserData();
                    }
                    
                    if (sidebar) {
                        sidebar.menuItems = Alpine.store('dashboard').getMenuItems();
                    }
                }
            } catch (error) {
                // Alpine store not ready, using hardcoded data
                console.log('Alpine store not ready:', error);
            }
        }
    </script>
</body>
</html>
